<div class="list-page card shadow-sm">
  <div class="card-body">
        <div class="row mb-3 g-2">
          <div class="col-auto">
            <label class="form-label mb-0">Desde</label>
            <input type="date" class="form-control" [(ngModel)]="filtroDesde" (change)="aplicarFiltro()">
          </div>
          <div class="col-auto">
            <label class="form-label mb-0">Hasta</label>
            <input type="date" class="form-control" [(ngModel)]="filtroHasta" (change)="aplicarFiltro()">
          </div>
          <div class="col-auto">
            <button class="btn btn-primary mt-4" (click)="filtroUltimos30Dias()">Últimos 30 días</button>
          </div>
          <div class="col-auto">
            <label class="form-label mb-0">Empresa</label>
            <input type="text" class="form-control" [(ngModel)]="filtroEmpresa" (input)="aplicarFiltro()">
          </div>
        </div>
        <div class="row mb-3 justify-content-between">
          <div class="col-auto">
            <button class="btn btn-outline-danger" (click)="borrarFiltros()">Borrar filtros</button>
          </div>
          <div class="col-auto ms-auto">
            <button class="btn btn-outline-primary me-2" (click)="exportarPDF()">Generar PDF</button>
            <button class="btn btn-primary" (click)="abrirNueva()">Nueva factura</button>
          </div>
        </div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Facturas</h2>
      <div class="d-flex gap-2">
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-sm" *ngIf="facturas.length > 0">
        <thead>
          <tr>
            <th class="text-center">Nº</th>
            <th (click)="ordenarPor('fecha')" style="cursor:pointer">Fecha <span *ngIf="sortBy==='fecha'">{{ sortOrder==='asc'?'▲':'▼' }}</span></th>
            <th>Código</th>
            <th (click)="ordenarPor('empresa')" style="cursor:pointer">Empresa <span *ngIf="sortBy==='empresa'">{{ sortOrder==='asc'?'▲':'▼' }}</span></th>
            <th>CIF</th>
            <th class="text-end">Base Imponible</th>
            <th class="text-end">IVA (%)</th>
            <th class="text-end">IVA (€)</th>
            <th class="text-end">Total</th>
            <th class="text-center"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let f of facturas; let i = index">
            <td class="text-center">{{ i + 1 }}</td>
            <td>{{ f.fecha }}</td>
            <td>{{ f.codigo }}</td>
            <td>{{ f.empresa }}</td>
            <td>{{ f.cif }}</td>
            <td class="text-end">{{ f.baseImponible | number:'1.2-2' }}</td>
            <td class="text-end">{{ f.porcentajeIVA | number:'1.0-2' }}</td>
            <td class="text-end">{{ f.valorIVA | number:'1.2-2' }}</td>
            <td class="text-end">{{ f.total | number:'1.2-2' }}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-info" (click)="abrirDetalle(f)">Ver</button>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="!loading && facturas.length === 0" class="alert alert-info mb-0">No hay facturas.</p>
      <p *ngIf="loading" class="text-muted mb-0">Cargando...</p>
    </div>
    @if (showFormModal) {
      <div class="modal-overlay" (click)="showFormModal = false">
        <div class="modal-card" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h5 class="modal-title">Nueva Factura</h5>
            <button type="button" class="btn-close" (click)="showFormModal = false"></button>
          </div>
          <div class="modal-body">
            <form (ngSubmit)="guardarFactura()">
              <div class="mb-2">
                <label class="form-label">Código</label>
                <input type="text" class="form-control" [(ngModel)]="factura.codigo" name="codigo" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" [(ngModel)]="factura.fecha" name="fecha" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Empresa</label>
                <input type="text" class="form-control" [(ngModel)]="factura.empresa" name="empresa" required (input)="buscarEmpresas(factura.empresa)" (change)="autocompletarCIF()">
                <div *ngIf="empresasSugeridas.length > 0" class="list-group position-absolute w-100">
                  <button type="button" class="list-group-item list-group-item-action" *ngFor="let e of empresasSugeridas" (click)="factura.empresa = e.nombre; factura.cif = e.cif; empresasSugeridas = []">{{ e.nombre }} ({{ e.cif }})</button>
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label">CIF</label>
                <input type="text" class="form-control" [(ngModel)]="factura.cif" name="cif" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Base Imponible</label>
                <input type="number" class="form-control" [(ngModel)]="factura.baseImponible" name="baseImponible" required (input)="calcularIVA()">
              </div>
              <div class="mb-2">
                <label class="form-label">IVA (%)</label>
                <input type="number" class="form-control" [(ngModel)]="factura.porcentajeIVA" name="porcentajeIVA" required (input)="calcularIVA()">
              </div>
              <div class="mb-2">
                <label class="form-label">IVA (€)</label>
                <input type="number" class="form-control bg-light" [value]="factura.valorIVA" readonly>
              </div>
              <div class="mb-2">
                <label class="form-label">Total</label>
                <input type="number" class="form-control bg-light" [value]="factura.total" readonly>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-secondary" (click)="showFormModal = false">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    }
    @if (facturaSeleccionada) {
      <div class="modal-overlay" (click)="cerrarDetalle()">
        <div class="modal-card" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h5 class="modal-title">Detalle de Factura</h5>
            <button type="button" class="btn-close" (click)="cerrarDetalle()"></button>
          </div>
          <div class="modal-body">
            <p><strong>Código:</strong> {{ facturaSeleccionada.codigo }}</p>
            <p><strong>Fecha:</strong> {{ facturaSeleccionada.fecha }}</p>
            <p><strong>Empresa:</strong> {{ facturaSeleccionada.empresa }}</p>
            <p><strong>CIF:</strong> {{ facturaSeleccionada.cif }}</p>
            <p><strong>Base Imponible:</strong> {{ facturaSeleccionada.baseImponible | number:'1.2-2' }} €</p>
            <p><strong>IVA (%):</strong> {{ facturaSeleccionada.porcentajeIVA | number:'1.0-2' }}%</p>
            <p><strong>IVA (€):</strong> {{ facturaSeleccionada.valorIVA | number:'1.2-2' }} €</p>
            <p><strong>Total:</strong> {{ facturaSeleccionada.total | number:'1.2-2' }} €</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" (click)="editarFactura(facturaSeleccionada)">Modificar</button>
            <button class="btn btn-danger" (click)="borrarFactura(facturaSeleccionada.codigo)">Borrar</button>
            <button class="btn btn-secondary" (click)="cerrarDetalle()">Cerrar</button>
          </div>
        </div>
      </div>
    }
  </div>
</div>
